<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>2FA Demo - login</title>
</head>
	<body>
		<div id="root">
			<form id="first-factor">
				<div>
					<label for="username">username</label>
					<input type="text" name="username" value="admin" disabled>
				</div>

				<div>
					<label for="password">password</label>
					<input type="password" name="password" value="admin" disabled>
					<input type="submit" value="login">
				</div>
			</form>

			<img id="qrcode" alt="qrcode" hidden>
			<form id="second-factor" hidden>
				<label for="token">authenticator code</label>
				<input type="number" name="token">
				<input type="hidden" name="secret">
				<input type="submit" value="submit">
			</form>
		</div>

		<script src="lib/otplib-preset-browser@^12.0.0-buffer.js"></script>
		<script src="lib/otplib-preset-browser@^12.0.0-index.js"></script>
		<script type="text/javascript">
			document.querySelector('#first-factor').onsubmit = submitFirstFactor;
			document.querySelector('#second-factor').onsubmit = submitSecondFactor;

			function submitFirstFactor(event) {
				event.preventDefault();
				const username = event.target.elements.username.value;
				const password = event.target.elements.password.value;
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({username, password}),
				};
				fetch('http://localhost:3000/api/auth/1fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => {
					showQRCode(json.imageUrl);
					show2FAForm(json.secret);
				})
				.catch(err => console.error(err));
				// const secret = 'KVKFKRCPNZQUYMLXOVYDSQKJKZDTSRLD';
				// const token = getToken(secret);
				// validateToken(token, secret)
				// .then(res => res.json())
				// .then(json => handleJsonError(json))
				// .then(json => showQRCode(json.imageUrl))
				// .catch(err => console.error(err));
			}

			function submitSecondFactor(event) {
				event.preventDefault();
				const token = event.target.elements.token.value;
				const secret = event.target.elements.secret.value;
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({token, secret}),
				};
				fetch('http://localhost:3000/api/auth/2fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => {
					const element = document.createElement(json.htmlText);
					document.querySelector('#root').appendChild(element);
				})
				.catch(err => console.error(err));
				// const secret = 'KVKFKRCPNZQUYMLXOVYDSQKJKZDTSRLD';
				// const token = getToken(secret);
				// validateToken(token, secret)
				// .then(res => res.json())
				// .then(json => handleJsonError(json))
				// .then(json => showQRCode(json.imageUrl))
				// .catch(err => console.error(err));
			}

			function getToken(secret) {
				return otplib.token.generate(secret);
			}

			// function validateToken(token, secret) {
			// 	const options = {
			// 		method: 'post',
			// 		headers: {
			// 			'Content-Type': 'application/*+json',
			//     },
			// 		body: token,
			// 	};
			// 	return fetch('http://localhost:3000/auth', options);
			// }

			function showQRCode(imageUrl) {
				const qrcode = document.querySelector('#qrcode');
				qrcode.src = imageUrl;
				qrcode.removeAttribute('hidden');
			}

			function show2FAForm(secret) {
				const form = document.querySelector('#second-factor');
				form.elements.secret.value = secret;
				form.removeAttribute('hidden');
			}

			function handleJsonError(json) {
				if (!json.err) {
					return json;
				}
				throw new Error(json.err);
			}
		</script>
	</body>
</html>