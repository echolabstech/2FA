<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>2FA Demo - login</title>
</head>
	<body>
		<div id="root">
			<form id="first-factor">
				<div>
					<label for="username">username</label>
					<input type="text" name="username" value="admin" disabled>
				</div>

				<div>
					<label for="password">password</label>
					<input type="password" name="password" value="admin" disabled>
					<input type="submit" value="login">
				</div>
			</form>

			<img id="qrcode" alt="qrcode" hidden>
			<form id="second-factor" hidden>
				<label for="token">authenticator code</label>
				<input type="number" name="token">
				<input type="hidden" name="secret">
				<input type="submit" value="submit">
			</form>
		</div>

		<script src="otplib-preset-browser@^12.0.0-buffer.js"></script>
		<script src="otplib-preset-browser@^12.0.0-index.js"></script>
		<script type="text/javascript">
			document.querySelector('#first-factor').onsubmit = submitFirstFactor;
			document.querySelector('#second-factor').onsubmit = submitSecondFactor;

			function submitFirstFactor(event) {
				event.preventDefault();
				const username = event.target.elements.username.value;
				const password = event.target.elements.password.value;
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({username, password}),
				};
				fetch('/api/auth/1fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => {
					showQRCode(json.imageUrl);
					show2FAForm(json.secret);
				})
				.catch(err => console.error(err));
			}

			function submitSecondFactor(event) {
				event.preventDefault();
				const token = event.target.elements.token.value;
				const secret = event.target.elements.secret.value;
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({token, secret}),
				};
				fetch('/api/auth/2fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => {
					const element = document.createElement('div');
					element.innerText = json.htmlText;
					document.querySelector('#root').appendChild(element);
				})
				.catch(err => console.error(err));
			}

			function showQRCode(imageUrl) {
				const qrcode = document.querySelector('#qrcode');
				qrcode.src = imageUrl;
				qrcode.removeAttribute('hidden');
			}

			function show2FAForm(secret) {
				const form = document.querySelector('#second-factor');
				form.elements.secret.value = secret;
				form.removeAttribute('hidden');
			}

			function handleJsonError(json) {
				if (!json.err) {
					return json;
				}
				throw new Error(json.err);
			}
		</script>
	</body>
</html>