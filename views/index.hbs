<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2FA Demo - login</title>
  <link rel="stylesheet" href="reset.css">
	<link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">
  <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
	<link rel="stylesheet" href="index.css">
</head>
	<body>
		<!-- <div class="scrimmed"></div> -->
		<div id="root" class="root">
			<div class="mdc-layout-grid">
			  <div class="mdc-layout-grid__inner">
			    <div class="mdc-layout-grid__cell--span-2-phone
			    						mdc-layout-grid__cell--span-3-tablet
	    								mdc-layout-grid__cell--span-4-desktop">foo</div>
					<div class="mdc-layout-grid__cell--span-2-phone
			    						mdc-layout-grid__cell--span-3-tablet
	    								mdc-layout-grid__cell--span-4-desktop">bar</div>
					<div class="mdc-layout-grid__cell--span-2-phone
			    						mdc-layout-grid__cell--span-3-tablet
	    								mdc-layout-grid__cell--span-4-desktop">foobar</div>
			  </div>
			</div>

			<!-- <p>Lorem ipsum dolor sit amet, consectetur adipisicing elit. Officiis quam illum magni animi ex qui, blanditiis neque atque modi eum quasi quaerat exercitationem porro ducimus magnam voluptatum vero aut aspernatur.</p>
			<div id="login" class="modal mdc-elevation--z12">
				<form id="first-factor">
					<div class="mdc-text-field
											mdc-text-field--outlined
											mdc-text-field--no-label">
					  <input class="mdc-text-field__input" type="text"
					  			 aria-label="Label" placeholder="username"
					  			 name="username" value="admin">
					  <span class="mdc-notched-outline">
					    <span class="mdc-notched-outline__leading"></span>
					    <span class="mdc-notched-outline__trailing"></span>
					  </span>
					</div>

					<div class="mdc-text-field
											mdc-text-field--outlined
											mdc-text-field--no-label">
					  <input class="mdc-text-field__input" type="password"
					  			 aria-label="Label" placeholder="password"
					  			 name="password" value="$trongp@ssw0rd">
					  <span class="mdc-notched-outline">
					    <span class="mdc-notched-outline__leading"></span>
					    <span class="mdc-notched-outline__trailing"></span>
					  </span>
					</div>
				  <button class="mdc-button--raised">
					  <span class="mdc-button__label">sign-in</span>
					</button>
				</form>

				<button class="mdc-button">
				   <div class="mdc-button__ripple"></div>
				   <span class="mdc-button__label">sign-up</span>
				</button>

				<img id="qrcode" alt="qrcode" hidden>

				<form id="second-factor" hidden>
					<label for="token">authenticator code</label>
					<input type="number" name="token">
					<input type="hidden" name="secret">
					<input type="submit" value="submit">
				</form>

				<div id="status"></div>
			</div> -->
		</div>

		<script src="otplib-preset-browser@^12.0.0-buffer.js"></script>
		<script src="otplib-preset-browser@^12.0.0-index.js"></script>
		<script type="text/javascript">
			const root = document.querySelector('#root');
			root.querySelector('#first-factor').onsubmit = submitFirstFactor;
			root.querySelector('#second-factor').onsubmit = submitSecondFactor;
			const status = root.querySelector('#status');

			function submitFirstFactor(event) {
				event.preventDefault();
				const username = event.target.elements.username.value;
				const password = event.target.elements.password.value;
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({username, password}),
				};
				fetch('/api/auth/1fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => {
					showQRCode(json.imageUrl);
					show2FAForm(json.secret);
				})
				.catch(err => console.error(err));
			}

			function submitSecondFactor(event) {
				event.preventDefault();
				updateStatus('loading...', 'info');
				const token = event.target.elements.token.value;
				const secret = event.target.elements.secret.value;
				if (!validateToken(token, secret)) return updateStatus('invalid token', 'error');
				const options = {
					method: 'post',
					headers: {
						'Content-Type': 'application/json',
			    },
					body: JSON.stringify({token, secret}),
				};
				fetch('/api/auth/2fa', options)
				.then(res => res.json())
				.then(json => handleJsonError(json))
				.then(json => updateStatus(json.htmlText, 'success'))
				.catch(err => updateStatus(err, 'error'));
			}

			function updateStatus(text, styleClass) {
				if (styleClass === 'error') {
					status.style.color = 'orangered';
				} else if (styleClass === 'success') {
					status.style.color = 'darkseagreen';
				} else if (styleClass == 'info') {
					status.style.color = 'dodgerblue';
				}
				status.innerText = text;
			}

			function validateToken(token, secret) {
				return otplib.authenticator.check(token, secret);
			}

			function showQRCode(imageUrl) {
				const qrcode = document.querySelector('#qrcode');
				qrcode.src = imageUrl;
				qrcode.removeAttribute('hidden');
			}

			function show2FAForm(secret) {
				const form = document.querySelector('#second-factor');
				form.elements.secret.value = secret;
				form.removeAttribute('hidden');
			}

			function handleJsonError(json) {
				if (!json.err) {
					return json;
				}
				throw new Error(json.err);
			}
		</script>
	</body>
</html>